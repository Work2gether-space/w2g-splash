<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Work2gether Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: #fff;
      color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .login-box {
      width: 320px;
      padding: 2.5rem;
      border: 1px solid #000;
      box-sizing: border-box;
      box-shadow: 0 0 15px rgba(180, 52, 14, 0.3);
      border-radius: 4px;
      text-align: center;
    }
    h2 {
      color: #B4340E;
      margin-bottom: 1.5rem;
      font-weight: 700;
    }
    p {
      margin-bottom: 2rem;
      font-weight: 500;
      font-size: 1rem;
    }
    input[type="email"] {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 1px solid #000;
      border-radius: 0;
      box-sizing: border-box;
      margin-bottom: 1.5rem;
      font-family: 'Montserrat', sans-serif;
    }
    button[type="submit"] {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-weight: 700;
      border: none;
      background: #000;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 0;
      font-family: 'Montserrat', sans-serif;
    }
    button[type="submit"]:hover,
    button[type="submit"]:focus {
      background: transparent;
      border: 1px solid #000;
      color: #000;
      outline: none;
    }
    .message { margin-top: 1.5rem; font-size: 0.9rem; font-weight: 500; color: #555; line-height: 1.3; }
    .status { margin-top: 0.75rem; min-height: 1.2em; }
  </style>
</head>
<body>
  <form class="login-box" id="loginForm" autocomplete="on" novalidate>
    <h2>Welcome to Work2gether</h2>
    <p>Please log in to start your session</p>

    <input type="email" id="email" name="email" placeholder="Your Email" required />
    <button type="submit">Start Session</button>

    <div class="message">
      Your time of access will determine how credits are used.<br />
      Make sure to log out if you're done.
    </div>
    <div id="status" class="status"></div>
  </form>

<script>
  // Build values from the portal query string
  const q = new URLSearchParams(location.search);

  // Omada usually includes these in the external portal URL:
  // clientMac, apMac, ssidName, radioId, site, redirectUrl
  const clientMac = q.get('clientMac') || q.get('mac') || '';
  const apMac     = q.get('apMac')     || q.get('ap')  || '';
  const ssidName  = q.get('ssidName')  || q.get('ssid')|| '';
  const radioId   = q.get('radioId')   || q.get('radio')|| '';
  const site      = q.get('site')      || '';
  const nextUrl   = decodeURIComponent(q.get('redirectUrl') || '') || 'http://neverssl.com';

  // keep a friendly client_id for logging if portal params are missing
  const clientIdForLog = clientMac || q.get('clientIp') || q.get('uip') || 'manual-test';

  const form = document.getElementById('loginForm');
  const statusEl = document.getElementById('status');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    statusEl.textContent = '';

    const email = document.getElementById('email').value.trim();
    if (!email) {
      statusEl.textContent = 'Enter a valid email.';
      statusEl.style.color = 'red';
      return;
    }

    try {
      // Call our backend authorizer (this talks to the OC200)
      const res = await fetch('/api/authorize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email,
          client_id: clientIdForLog,
          clientMac, apMac, ssidName, radioId, site,
          redirectUrl: nextUrl
        })
      });

      if (!res.ok) {
        const t = await res.text();
        console.error('API error:', t);
        statusEl.textContent = 'Network/authorize error. Try again.';
        statusEl.style.color = 'red';
        return;
      }

      const data = await res.json();
      if (data && data.ok) {
        statusEl.textContent = 'Saved. Finishing sign-in…';
        statusEl.style.color = 'green';
        // Prefer server-provided redirect, else the portal’s original redirectUrl
        const go = data.redirectUrl || nextUrl;
        setTimeout(() => { location.href = go; }, 400);
      } else {
        console.error('Authorize failed:', data);
        statusEl.textContent = 'Authorization failed. Try again.';
        statusEl.style.color = 'red';
      }
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Network error. Try again.';
      statusEl.style.color = 'red';
    }
  });
</script>
</body>
</html>
