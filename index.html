<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Work2gether Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root { --accent:#B4340E; --ink:#000; --bg:#fff; }
    * { box-sizing:border-box; }
    body {
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink);
    }
    .card {
      width:320px; padding:2.25rem; border:1px solid var(--ink); border-radius:4px;
      box-shadow:0 0 15px rgba(180,52,14,.25); text-align:center; background:#fff;
    }
    h1 { font-size:1.15rem; margin:0 0 .25rem; color:var(--accent); font-weight:700; }
    h2 { font-size:.95rem; margin:0 0 1rem; font-weight:600; }
    input[type="email"] {
      width:100%; padding:.75rem 1rem; border:1px solid #000; border-radius:0; margin:.5rem 0 1rem; font:inherit;
    }
    button {
      width:100%; padding:.75rem 1rem; border:0; background:#000; color:#fff; font-weight:700; cursor:pointer;
    }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    button:hover, button:focus { outline:0; background:#fff; color:#000; border:1px solid #000; }
    .fine { margin-top:1rem; font-size:.82rem; color:#555; line-height:1.25; }
    .status { min-height:1.2em; margin-top:.75rem; font-size:.9rem; }
    .status.err { color:#b00020; }
    .status.ok { color:#0a7a33; }
    .debug {
      margin-top:1rem; text-align:left; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:.78rem; background:#fafafa; border:1px dashed #bbb; padding:.75rem; display:none; max-height:200px; overflow:auto;
    }
  </style>
</head>
<body>
  <main class="card">
    <h1>Welcome to Work2gether</h1>
    <h2>Please log in to start your session</h2>

    <form id="form" novalidate>
      <input type="email" id="email" name="email" placeholder="Your Email" autocomplete="email" required />
      <button id="submitBtn" type="submit">Start Session</button>
      <div id="status" class="status" aria-live="polite"></div>
    </form>

    <p class="fine">
      Your time of access will determine how credits are used.
      Make sure to log out if you are done.
    </p>

    <details id="dbgWrap" class="debug">
      <summary>Debug (payload and URL params)</summary>
      <pre id="debugBox"></pre>
    </details>
  </main>

  <script>
    // Helpers
    const qs = new URLSearchParams(location.search);

    // Pull Omada params
    const portalParams = {
      clientMac  : qs.get('clientMac') || qs.get('mac') || '',
      apMac      : qs.get('apMac') || '',
      ssidName   : qs.get('ssidName') || qs.get('ssid') || '',
      radioId    : qs.get('radioId') || qs.get('radio') || '',
      site       : qs.get('site') || '',
      clientIp   : qs.get('clientIp') || qs.get('uip') || '',
      redirectUrl: decodeURIComponent(qs.get('redirectUrl') || '') || 'http://neverssl.com'
    };

    // Defaults the API may use
    const DEFAULT_TIME = 86400000;
    const DEFAULT_AUTH_TYPE = 4;

    // Optional debug
    const DEBUG = qs.get('debug') === '1';

    const $form = document.getElementById('form');
    const $btn  = document.getElementById('submitBtn');
    const $status = document.getElementById('status');
    const $dbg = document.getElementById('dbgWrap');
    const $box = document.getElementById('debugBox');

    if (DEBUG) {
      $dbg.style.display = 'block';
      $box.textContent = [
        'URL Params:', JSON.stringify(portalParams, null, 2),
        '',
        'Full query:', location.search
      ].join('\n');
      console.log('[splash] URL params', portalParams);
    }

    function setStatus(msg, kind='') {
      $status.className = 'status ' + (kind || '');
      $status.textContent = msg || '';
    }

    function isValidEmail(s) {
      return typeof s === 'string' && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
    }

    async function postJSON(url, body) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      return { res, text: await res.text() };
    }

    $form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('');
      const email = document.getElementById('email').value.trim();

      if (!isValidEmail(email)) {
        setStatus('Enter a valid email.', 'err');
        return;
      }

      const payload = {
        email,
        clientMac  : portalParams.clientMac,
        apMac      : portalParams.apMac,
        ssidName   : portalParams.ssidName,
        radioId    : portalParams.radioId,
        site       : portalParams.site,
        clientIp   : portalParams.clientIp,
        redirectUrl: portalParams.redirectUrl,
        time       : DEFAULT_TIME,
        authType   : DEFAULT_AUTH_TYPE
      };

      if (DEBUG) {
        $box.textContent += '\n\nSubmit payload:\n' + JSON.stringify(payload, null, 2);
        console.log('[splash] submit payload', payload);
      }

      try {
        $btn.disabled = true;

        // 1) fire and forget email capture
        try {
          const r1 = await postJSON('/api/submit_email', { email, client_id: portalParams.clientMac || 'manual' });
          if (DEBUG) console.log('[splash] submit_email', r1.res.status, r1.text);
        } catch (err) {
          if (DEBUG) console.warn('[splash] submit_email failed', err);
        }

        // 2) authorize with controller
        setStatus('Authorizing…');
        const { res, text } = await postJSON('/api/authorize', payload);

        if (!res.ok) {
          if (DEBUG) console.error('[splash] /api/authorize error', res.status, text);
          setStatus('Could not authorize your session. Try again.', 'err');
          return;
        }

        let data = {};
        try { data = JSON.parse(text); } catch {}
        if (DEBUG) console.log('[splash] /api/authorize ok', data);

        setStatus('Authorized. Finishing sign in…', 'ok');
        const next = (data && data.redirectUrl) || portalParams.redirectUrl || 'http://neverssl.com';
        setTimeout(() => { location.href = next; }, 400);
      } catch (err) {
        if (DEBUG) console.error('[splash] fatal', err);
        setStatus('Network error. Try again.', 'err');
      } finally {
        $btn.disabled = false;
      }
    });

    if (DEBUG && (!portalParams.clientMac || !portalParams.site)) {
      $box.textContent += '\n\nWARNING: Missing clientMac or site from URL. The controller may reject authorization.';
    }
  </script>
</body>
</html>

