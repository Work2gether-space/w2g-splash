<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Work2gether Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: #fff;
      color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .login-box {
      width: 320px;
      padding: 2.5rem;
      border: 1px solid #000;
      box-sizing: border-box;
      box-shadow: 0 0 15px rgba(180, 52, 14, 0.3);
      border-radius: 4px;
      text-align: center;
    }
    h2 { color: #B4340E; margin-bottom: 1.5rem; font-weight: 700; }
    p { margin-bottom: 2rem; font-weight: 500; font-size: 1rem; }
    input[type="email"] {
      width: 100%; padding: 0.75rem 1rem; font-size: 1rem;
      border: 1px solid #000; border-radius: 0; box-sizing: border-box; margin-bottom: 1.5rem;
      font-family: 'Montserrat', sans-serif;
    }
    button[type="submit"] {
      width: 100%; padding: 0.75rem 1rem; font-size: 1rem; font-weight: 700;
      border: none; background: #000; color: #fff; cursor: pointer; transition: all 0.3s ease; border-radius: 0;
      font-family: 'Montserrat', sans-serif;
    }
    button[type="submit"]:hover, button[type="submit"]:focus {
      background: transparent; border: 1px solid #000; color: #000; outline: none;
    }
    .message { margin-top: 1.0rem; font-size: 0.9rem; font-weight: 500; color: #555; line-height: 1.3; }
    .status  { margin-top: 0.75rem; min-height: 1.2em; }
    .small   { margin-top: .5rem; font-size: .8rem; color:#666; }
    .dim     { color:#999; font-size: .8rem; margin-top:.25rem;}
  </style>
</head>
<body>
  <form class="login-box" id="loginForm" autocomplete="on" novalidate>
    <h2>Welcome to Work2gether</h2>
    <p>Please log in to start your session</p>

    <input type="email" id="email" name="email" placeholder="Your Email" required />
    <button type="submit">Start Session</button>

    <div class="message">
      Your time of access will determine how credits are used.<br />
      Make sure to log out if you're done.
    </div>
    <div id="status" class="status"></div>
    <div class="dim" id="qs"></div>
  </form>

  <script>
    // Read and show important portal query string values (for debugging)
    const q = new URLSearchParams(location.search);
    const qsEl = document.getElementById('qs');
    const portalParams = {
      clientMac: q.get('clientMac') || q.get('mac') || '',
      apMac:     q.get('apMac') || '',
      ssidName:  q.get('ssidName') || '',
      radioId:   q.get('radioId') || '',
      site:      q.get('site') || '',
      redirectUrl: decodeURIComponent(q.get('redirectUrl') || '') || 'http://neverssl.com'
    };
    qsEl.textContent = `site=${portalParams.site} • clientMac=${portalParams.clientMac} • apMac=${portalParams.apMac}`;

    const form = document.getElementById('loginForm');
    const statusEl = document.getElementById('status');

    async function postJson(url, body) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body || {})
      });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { raw: text }; }
      return { ok: res.ok, status: res.status, data };
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = '';

      const email = document.getElementById('email').value.trim();
      if (!email) {
        statusEl.textContent = 'Enter a valid email.';
        statusEl.style.color = 'red';
        return;
      }

      try {
        // 1) Capture email (always returns 200 w/ logs)
        const cap = await postJson('/api/submit_email', { email, client_id: portalParams.clientMac || 'n/a' });
        if (!cap.ok) {
          console.error('submit_email error:', cap);
          statusEl.textContent = 'Network error (capture). Try again.';
          statusEl.style.color = 'red';
          return;
        }

        // 2) Ask our API to authorize this client with Omada
        statusEl.textContent = 'Authorizing…';
        statusEl.style.color = '#333';

        const authBody = {
          clientMac: portalParams.clientMac,
          apMac: portalParams.apMac,
          ssidName: portalParams.ssidName,
          radioId: portalParams.radioId,
          site: portalParams.site,
          redirectUrl: portalParams.redirectUrl
        };
        const auth = await postJson('/api/authorize', authBody);

        if (!auth.ok) {
          console.error('authorize error payload:', auth);
          statusEl.innerHTML = 'Could not authorize your session. Try again.';
          statusEl.style.color = 'red';
          return;
        }

        const go = (auth.data && auth.data.redirectUrl) ? auth.data.redirectUrl : portalParams.redirectUrl;
        statusEl.textContent = 'Authorized. Finishing sign-in…';
        statusEl.style.color = 'green';
        setTimeout(() => (location.href = go), 500);
      } catch (err) {
        console.error('fatal error:', err);
        statusEl.textContent = 'Network error. Try again.';
        statusEl.style.color = 'red';
      }
    });
  </script>
</body>
</html>
